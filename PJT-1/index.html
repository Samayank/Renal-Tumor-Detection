<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Hub: Fused AI Framework for Renal Tumor Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Warm Stone & Muted Blue -->
    <!-- Application Structure Plan: The application is designed as a single-page, tab-style dashboard. This structure was chosen over a linear document to better serve a small, focused team. It allows users to quickly switch between different contexts: a high-level 'Dashboard' for the overall workflow, a role-specific 'Team & Tasks' view for personalized checklists, a detailed 'Playbook' for step-by-step implementation, a 'Toolkit' for quick reference to tools/data, and a 'Knowledge Base' for foundational concepts. This task-oriented design reduces cognitive load and helps team members, especially those new to ML, find the exact information they need without getting lost in a long document. A new 'AI Assistant' tab centralizes LLM-powered features for task breakdown, concept explanation, and risk identification. -->
    <!-- Visualization & Content Choices: 
        - Report Info: Overall Project Plan -> Goal: Organize/Inform -> Viz/Presentation: HTML/CSS Flowchart -> Interaction: Visual guide -> Justification: To provide a persistent, high-level map of the project's stages, acting as a visual anchor.
        - Report Info: Team Responsibility Matrix -> Goal: Organize/Personalize -> Viz/Presentation: Interactive Filtered List -> Interaction: Click role buttons to filter tasks -> Justification: To create actionable, personalized checklists for each team member, making their responsibilities clear and immediate. This is the core interactive element.
        - Report Info: Phased Implementation Details -> Goal: Organize/Inform -> Viz/Presentation: HTML/JS Accordion -> Interaction: Click to expand/collapse sections -> Justification: To present dense, step-by-step instructions in a digestible, progressive-disclosure format, preventing information overload.
        - Report Info: Evaluation Metrics & Goals -> Goal: Compare/Inform -> Viz/Presentation: Chart.js Bar Chart -> Interaction: Hover for tooltips -> Justification: To visually communicate the project's central hypothesis‚Äîthat the fused model will outperform single-modality models‚Äîand to make the target metrics clear.
        - Report Info: Core Concepts (U-Net, RNA-Seq, etc.) -> Goal: Inform -> Viz/Presentation: Styled Text Blocks -> Interaction: Read/Reference -> Justification: To create an on-demand internal wiki for the team to reference complex topics as needed.
        - New Feature: Gemini API Integration -> Goal: Augment/Assist -> Viz/Presentation: Interactive AI tools (text inputs, dropdowns, buttons) -> Interaction: User provides context (task, concept, phase), clicks button to trigger Gemini API call, and receives generated text (sub-tasks, explanations, risks) in a dedicated output area. -> Justification: To transform the static hub into a dynamic assistant, actively helping the team overcome common project hurdles like task planning, knowledge gaps, and risk assessment.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        .nav-link {
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
        }
        .nav-link.active {
            border-bottom-color: #2563eb; /* blue-600 */
            color: #1e3a8a; /* blue-900 */
        }
        .task-card.hidden {
            display: none;
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .accordion-content.open {
            max-height: 2000px; /* Adjust as needed */
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .gemini-output {
            white-space: pre-wrap;
            background-color: #f0f9ff; /* sky-50 */
            border-left: 4px solid #0284c7; /* sky-600 */
            padding: 1rem;
            border-radius: 0.25rem;
            margin-top: 1rem;
            font-family: monospace;
            color: #0c4a6e; /* sky-900 */
        }
        .channel-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            border: 1px solid #d1d5db;
            background-color: white;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
        }
        .channel-btn:hover {
            background-color: #f3f4f6;
        }
        .channel-btn.active {
            background-color: #2563eb;
            color: white;
            border-color: #2563eb;
        }
    </style>
</head>
<body class="text-slate-700">
    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-30 z-50">
      <div class="bg-white p-8 rounded-lg shadow-lg w-80 flex flex-col gap-4">
        <h2 class="text-xl font-bold text-slate-800 mb-2">Login</h2>
        <label class="font-semibold">Profile:</label>
        <select id="login-user-select" class="p-2 border rounded">
          <option value="Samayank">Samayank</option>
          <option value="Sarthak">Sarthak</option>
          <option value="Daksh">Daksh</option>
        </select>
        <label class="font-semibold">Password:</label>
        <input type="password" id="login-password" class="p-2 border rounded" placeholder="Password">
        <button id="login-submit-btn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Login</button>
        <div id="login-error-msg" class="text-red-600 text-sm hidden"></div>
      </div>
    </div>
    <!-- User Selector Dropdown -->
    <div id="user-selector" class="fixed top-2 right-4 z-50 bg-white p-2 rounded shadow flex items-center gap-2 hidden">
      <label for="user-select" class="font-semibold">Profile:</label>
      <select id="user-select" class="p-1 border rounded"></select>
      <button id="logout-btn" class="ml-2 px-2 py-1 bg-gray-200 rounded hover:bg-gray-300">Logout</button>
    </div>

    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col sm:flex-row items-center justify-between py-4">
                <h1 class="text-xl md:text-2xl font-bold text-slate-800 text-center sm:text-left">Fused AI Framework for Renal Tumor Analysis</h1>
                <nav id="main-nav" class="flex flex-wrap justify-center gap-x-4 gap-y-2 mt-4 sm:mt-0">
                    <a href="#dashboard" class="nav-link font-medium text-slate-600 hover:text-blue-600 px-3 py-2 text-sm">Dashboard</a>
                    <a href="#team" class="nav-link font-medium text-slate-600 hover:text-blue-600 px-3 py-2 text-sm">Team & Tasks</a>
                    <a href="#playbook" class="nav-link font-medium text-slate-600 hover:text-blue-600 px-3 py-2 text-sm">The Playbook</a>
                    <a href="#toolkit" class="nav-link font-medium text-slate-600 hover:text-blue-600 px-3 py-2 text-sm">Toolkit</a>
                    <a href="#knowledge" class="nav-link font-medium text-slate-600 hover:text-blue-600 px-3 py-2 text-sm">Knowledge Base</a>
                    <a href="#ai-assistant" class="nav-link font-medium text-slate-600 hover:text-blue-600 px-3 py-2 text-sm">‚ú® AI Assistant</a>
                    <a href="#chat" class="nav-link font-medium text-slate-600 hover:text-blue-600 px-3 py-2 text-sm">üí¨ Team Chat</a>
                    <a href="#notes" class="nav-link font-medium text-slate-600 hover:text-blue-600 px-3 py-2 text-sm">üìù Progress Notes</a>
                </nav>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <section id="dashboard" class="page-section space-y-8">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold text-slate-800 mb-4">Project Dashboard</h2>
                <p class="text-slate-600 leading-relaxed">Welcome to the project hub. This application provides a comprehensive, interactive guide to our research on a fused deep-learning framework for renal tumor classification. Its purpose is to break down the complex project plan into actionable stages, clarify roles, and provide all necessary resources. Use the navigation above to explore the project's workflow, your specific tasks, the implementation playbook, and the core concepts behind our methodology.</p>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-xl font-bold text-slate-800 mb-6 text-center">End-to-End Project Workflow</h3>
                <div class="flex flex-col md:flex-row items-center justify-center gap-4 text-center text-sm">
                    <div class="flex-1 p-4 bg-slate-100 rounded-lg shadow-sm">
                        <div class="font-bold text-blue-700 mb-1">Stage 1</div>
                        <p>Tumor Detection & Segmentation (3D U-Net)</p>
                    </div>
                    <div class="text-2xl font-mono text-slate-400 mx-2 transform rotate-90 md:rotate-0">&rarr;</div>
                    <div class="flex-1 p-4 bg-slate-100 rounded-lg shadow-sm">
                        <div class="font-bold text-blue-700 mb-1">Stage 2A & 2B</div>
                        <p>Parallel Subtype Classification (CT-CNN & Genomics-MLP)</p>
                    </div>
                    <div class="text-2xl font-mono text-slate-400 mx-2 transform rotate-90 md:rotate-0">&rarr;</div>
                    <div class="flex-1 p-4 bg-slate-100 rounded-lg shadow-sm">
                        <div class="font-bold text-blue-700 mb-1">Fusion</div>
                        <p>Late-Fusion for Final Prediction (Stacking)</p>
                    </div>
                    <div class="text-2xl font-mono text-slate-400 mx-2 transform rotate-90 md:rotate-0">&rarr;</div>
                    <div class="flex-1 p-4 bg-slate-100 rounded-lg shadow-sm">
                        <div class="font-bold text-blue-700 mb-1">Evaluation</div>
                        <p>Metrics & Explainability (Dice, AUC, Grad-CAM, SHAP)</p>
                    </div>
                </div>
            </div>

            <div class="grid md:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-lg shadow-md">
                     <h3 class="text-xl font-bold text-slate-800 mb-4">Core Objectives</h3>
                     <ul class="list-disc list-inside space-y-2 text-slate-600">
                        <li>Develop a <strong>modular, two-stage pipeline</strong> for renal tumor analysis.</li>
                        <li>Achieve <strong>automatic segmentation</strong> to eliminate manual ROI drawing.</li>
                        <li>Implement <strong>dual-modality fusion</strong> of CT and genomic data for superior classification.</li>
                        <li>Ensure <strong>interpretability</strong> for each modality using Grad-CAM and SHAP.</li>
                        <li>Build a <strong>reproducible framework</strong> using public datasets (KiTS23, TCGA).</li>
                     </ul>
                </div>
                 <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold text-slate-800 mb-4">Hypothesized Performance Gains</h3>
                    <p class="text-slate-600 mb-4 text-sm">Our central hypothesis is that the fused model will significantly outperform models using only a single data modality. This chart shows the target AUC scores we aim to achieve and compare.</p>
                    <div class="chart-container">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <section id="team" class="page-section hidden space-y-6">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold text-slate-800 mb-2">Team Roles & Task Assignments</h2>
                <p class="text-slate-600 leading-relaxed mb-6">This section provides a personalized view of the project plan. Select your role to filter the master task list and see all responsibilities assigned to you across every phase of the project. This helps you focus on your specific contributions while understanding how they fit into the larger picture. The "Integration & Evaluation Lead" is responsible for the tasks that connect the two specialist streams.</p>
                <div id="role-filter" class="flex flex-wrap justify-center gap-3 mb-6">
                    <button data-role="all" class="role-btn active bg-blue-600 text-white font-semibold py-2 px-4 rounded-full shadow-md transition-transform transform hover:scale-105">All Tasks</button>
                    <button data-role="imaging" class="role-btn bg-white text-blue-600 font-semibold py-2 px-4 rounded-full border border-blue-600 hover:bg-blue-50 transition-transform transform hover:scale-105">Imaging Specialist</button>
                    <button data-role="genomics" class="role-btn bg-white text-green-600 font-semibold py-2 px-4 rounded-full border border-green-600 hover:bg-green-50 transition-transform transform hover:scale-105">Genomics Specialist</button>
                    <button data-role="integration" class="role-btn bg-white text-amber-600 font-semibold py-2 px-4 rounded-full border border-amber-600 hover:bg-amber-50 transition-transform transform hover:scale-105">Integration & Eval Lead</button>
                </div>
            </div>
            <div id="task-list" class="space-y-4"></div>
        </section>

        <section id="playbook" class="page-section hidden space-y-6">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold text-slate-800 mb-2">The Implementation Playbook</h2>
                <p class="text-slate-600 leading-relaxed">This is the core technical guide for the project, broken down into sequential phases. Each phase contains the specific steps, procedures, and code snippets required for implementation. This structured playbook ensures a systematic and reproducible workflow from data acquisition to final model evaluation. Click on any phase to expand its details.</p>
            </div>
            <div id="accordion-container" class="space-y-3"></div>
        </section>
        
        <section id="toolkit" class="page-section hidden space-y-6">
             <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold text-slate-800 mb-2">Project Toolkit: Data & Libraries</h2>
                <p class="text-slate-600 leading-relaxed">This section is a quick-reference guide to the essential datasets and software libraries for the project. It includes access links for data and installation commands for setting up the standardized `conda` environment. Ensuring all team members use this exact toolkit is crucial for reproducibility.</p>
            </div>
            <div class="grid md:grid-cols-2 gap-6">
                <div id="libraries-toolkit"></div>
                <div id="datasets-toolkit"></div>
            </div>
        </section>

        <section id="knowledge" class="page-section hidden space-y-6">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold text-slate-800 mb-2">Knowledge Base</h2>
                <p class="text-slate-600 leading-relaxed">This section serves as the project's internal wiki, providing clear explanations of the core scientific and technical concepts. Before diving into implementation, it is vital that all team members have a shared understanding of the clinical context, the machine learning architectures, and the data modalities we are working with. Refer back to this section anytime to refresh your understanding of these foundational principles.</p>
            </div>
            <div id="knowledge-base-container" class="space-y-6"></div>
        </section>

        <section id="ai-assistant" class="page-section hidden space-y-8">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold text-slate-800 mb-2">‚ú® AI Project Assistant</h2>
                <p class="text-slate-600 leading-relaxed">Leverage the power of the Gemini API to accelerate your project. This assistant can help you break down complex tasks, understand difficult concepts, and identify potential risks before they become problems. Select a tool below to get started.</p>
            </div>

            <div class="grid md:grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Task Decomposer -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold text-slate-800 mb-4">Task Decomposer</h3>
                    <p class="text-slate-600 text-sm mb-4">Enter a high-level task to generate a detailed checklist of sub-tasks.</p>
                    <textarea id="task-input" class="w-full p-2 border rounded-md h-24" placeholder="e.g., Implement the MONAI preprocessing pipeline for all CT data."></textarea>
                    <button id="decompose-task-btn" class="mt-4 w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-md shadow-sm hover:bg-blue-700 flex items-center justify-center gap-2 disabled:bg-slate-400">
                        <span class="btn-text">‚ú® Generate Sub-tasks</span>
                        <div class="loader hidden"></div>
                    </button>
                    <div id="task-output" class="gemini-output hidden"></div>
                </div>

                <!-- Concept Explainer -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold text-slate-800 mb-4">Concept Explainer</h3>
                    <p class="text-slate-600 text-sm mb-4">Select a concept for a simplified, easy-to-understand explanation.</p>
                    <select id="concept-select" class="w-full p-2 border rounded-md bg-white"></select>
                    <button id="explain-concept-btn" class="mt-4 w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-md shadow-sm hover:bg-blue-700 flex items-center justify-center gap-2 disabled:bg-slate-400">
                        <span class="btn-text">‚ú® Explain Concept</span>
                        <div class="loader hidden"></div>
                    </button>
                    <div id="concept-output" class="gemini-output hidden"></div>
                </div>

                <!-- Risk Identifier -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold text-slate-800 mb-4">Risk Identifier</h3>
                    <p class="text-slate-600 text-sm mb-4">Select a project phase to identify potential risks and mitigation strategies.</p>
                    <select id="playbook-select" class="w-full p-2 border rounded-md bg-white"></select>
                    <button id="identify-risk-btn" class="mt-4 w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-md shadow-sm hover:bg-blue-700 flex items-center justify-center gap-2 disabled:bg-slate-400">
                        <span class="btn-text">‚ú® Identify Risks</span>
                        <div class="loader hidden"></div>
                    </button>
                    <div id="risk-output" class="gemini-output hidden"></div>
                </div>
            </div>
        </section>

        <!-- Team Chat Section -->
        <section id="chat" class="page-section hidden space-y-6">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold text-slate-800 mb-2">üí¨ Team Chat</h2>
                <p class="text-slate-600 leading-relaxed">Real-time communication channels for each project phase. Stay connected with your team, share updates, and coordinate your work efficiently.</p>
                <button id="clear-chat-btn" class="mt-4 bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">Clear Chat</button>
            </div>

            <!-- Login prompt (shown when not authenticated) -->
            <div id="login-prompt" class="bg-white p-6 rounded-lg shadow-md text-center">
                <h3 class="text-xl font-bold text-slate-800 mb-4">Please log in to access team chat</h3>
                <div class="space-y-4">
                    <div>
                        <input type="email" id="login-email" placeholder="Email" class="w-full p-3 border rounded-md">
                    </div>
                    <div>
                        <input type="password" id="login-password" placeholder="Password" class="w-full p-3 border rounded-md">
                    </div>
                    <button id="login-btn" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700">Login</button>
                </div>
                <div id="login-error" class="mt-4 text-red-600 hidden"></div>
            </div>

            <!-- Chat interface (shown when authenticated) -->
            <div id="chat-interface" class="hidden">
                <!-- Channel selection -->
                <div class="bg-white p-4 rounded-lg shadow-md mb-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-3">Select Channel</h3>
                    <div class="flex flex-wrap gap-2">
                        <button class="channel-btn active" data-channel="general">üè† General</button>
                        <button class="channel-btn" data-channel="imaging">üñºÔ∏è Imaging</button>
                        <button class="channel-btn" data-channel="genomics">üß¨ Genomics</button>
                        <button class="channel-btn" data-channel="integration">üîó Integration</button>
                    </div>
                </div>

                <!-- Chat messages -->
                <div class="bg-white rounded-lg shadow-md flex flex-col h-96">
                    <div class="p-4 border-b">
                        <h3 class="font-bold text-slate-800" id="current-channel">General Chat</h3>
                    </div>
                    <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-3">
                        <!-- Messages will be inserted here -->
                    </div>
                    <div class="p-4 border-t">
                        <div class="flex gap-2">
                            <input type="text" id="message-input" placeholder="Type your message..." class="flex-1 p-2 border rounded-md">
                            <button id="send-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Progress Notes Section -->
        <section id="notes" class="page-section hidden space-y-6">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold text-slate-800 mb-2">üìù Progress Notes</h2>
                <p class="text-slate-600 leading-relaxed">Document your progress, share insights, and keep track of completed tasks. These notes help the entire team stay informed about the current status of each project phase.</p>
                <button id="clear-notes-btn" class="mt-4 bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">Clear All Notes</button>
            </div>

            <!-- Create new note -->
            <div id="note-creator" class="bg-white p-6 rounded-lg shadow-md hidden">
                <h3 class="text-xl font-bold text-slate-800 mb-4">Create New Note</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Title</label>
                        <input type="text" id="note-title" placeholder="Note title" class="w-full p-3 border rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Project Phase</label>
                        <select id="note-phase" class="w-full p-3 border rounded-md">
                            <option value="general">General</option>
                            <option value="foundations">I. Foundations</option>
                            <option value="data-acquisition">II. Data Acquisition</option>
                            <option value="segmentation">III. Segmentation</option>
                            <option value="ct-classification">IV. CT Classification</option>
                            <option value="genomics-classification">V. Genomics Classification</option>
                            <option value="fusion">VI. Fusion</option>
                            <option value="explainability">VII. Explainability</option>
                            <option value="evaluation">VIII. Evaluation</option>
                            <option value="dissemination">IX. Dissemination</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Content</label>
                        <textarea id="note-content" placeholder="Write your progress update, findings, or notes here..." class="w-full p-3 border rounded-md h-32"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Tags (comma-separated)</label>
                        <input type="text" id="note-tags" placeholder="progress, completed, issue, insight" class="w-full p-3 border rounded-md">
                    </div>
                    <div class="flex gap-2">
                        <button id="save-note-btn" class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700">Save Note</button>
                        <button id="cancel-note-btn" class="bg-gray-500 text-white px-6 py-2 rounded-md hover:bg-gray-600">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- Notes list -->
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-slate-800">Team Progress Notes</h3>
                    <button id="add-note-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 hidden">+ Add Note</button>
                </div>
                <div id="notes-container">
                    <!-- Notes will be loaded here -->
                </div>
            </div>
        </section>

    </main>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // --- User Selector Setup ---
            let users = [
                { _id: '1', name: 'Samayank' },
                { _id: '2', name: 'Sarthak' },
                { _id: '3', name: 'Daksh' }
            ];
            try {
                const res = await fetch('/api/users');
                if (res.ok) users = await res.json();
            } catch (e) {}
            const userSelect = document.getElementById('user-select');
            users.forEach(u => {
                const opt = document.createElement('option');
                opt.value = u._id;
                opt.textContent = u.name;
                userSelect.appendChild(opt);
            });
            let currentUserId = null;
            let currentUser = null;
            // Hide all app content until login
            const appContent = document.querySelector('body > *:not(#login-modal)');
            const loginModal = document.getElementById('login-modal');
            const userSelector = document.getElementById('user-selector');
            function showApp() {
                loginModal.classList.add('hidden');
                userSelector.classList.remove('hidden');
                document.querySelectorAll('.page-section, header, main').forEach(e => e.style.display = '');
            }
            function hideApp() {
                loginModal.classList.remove('hidden');
                userSelector.classList.add('hidden');
                document.querySelectorAll('.page-section, header, main').forEach(e => e.style.display = 'none');
            }
            hideApp();

            const sections = document.querySelectorAll('.page-section');
            const navLinks = document.querySelectorAll('#main-nav a');
            const roleFilterButtons = document.querySelectorAll('#role-filter button');
            const taskListContainer = document.getElementById('task-list');
            const accordionContainer = document.getElementById('accordion-container');
            const librariesContainer = document.getElementById('libraries-toolkit');
            const datasetsContainer = document.getElementById('datasets-toolkit');
            const knowledgeBaseContainer = document.getElementById('knowledge-base-container');

            const tasks = [
                { phase: 'I. Foundations', role: ['imaging'], text: 'Lead setup of MONAI/PyTorch environment. Master 3D U-Net and CNN concepts.' },
                { phase: 'I. Foundations', role: ['genomics'], text: 'Lead setup of Pandas/Scikit-learn environment. Master RNA-Seq concepts and feature selection.' },
                { phase: 'I. Foundations', role: ['integration'], text: 'Establish GitHub repository and Git workflow. Master evaluation metrics and fusion concepts.' },
                { phase: 'II. Data Acquisition', role: ['imaging'], text: 'Download KiTS23 dataset. Download TCGA imaging data (DICOM) from TCIA. Convert DICOM to NIfTI format.' },
                { phase: 'II. Data Acquisition', role: ['genomics'], text: 'Download TCGA RNA-Seq and clinical data from GDC Data Portal. Perform initial cleaning of tabular data.' },
                { phase: 'II. Data Acquisition', role: ['integration'], text: '<strong>Lead the critical task of matching TCGA imaging and genomic data using patient IDs.</strong> Create and maintain the final harmonized master DataFrame.' },
                { phase: 'III. Stage 1 (Segmentation)', role: ['imaging'], text: '<strong>Implement the MONAI preprocessing pipeline for all CT data.</strong> Build, train, and validate the 3D U-Net model on the KiTS23 dataset.' },
                { phase: 'III. Stage 1 (Segmentation)', role: ['genomics', 'integration'], text: 'Provide support and review of the segmentation model\'s performance.' },
                { phase: 'IV. Stage 2A (CT-only Class.)', role: ['imaging'], text: '<strong>Run the trained U-Net on TCGA scans to generate masks.</strong> Implement the tumor ROI cropping pipeline. Build, train, and validate the 3D DenseNet classifier on cropped TCGA ROIs.' },
                { phase: 'IV. Stage 2A (CT-only Class.)', role: ['integration'], text: 'Provide the matched subtype labels from the master DataFrame for training.' },
                { phase: 'V. Stage 2B (Genomic-only Class.)', role: ['genomics'], text: '<strong>Implement the genomic feature selection pipeline.</strong> Build, train, and validate the MLP classifier on TCGA genomic data.' },
                { phase: 'V. Stage 2B (Genomic-only Class.)', role: ['integration'], text: 'Provide the matched subtype labels from the master DataFrame for training.' },
                { phase: 'VI. Fusion Stage', role: ['imaging', 'genomics'], text: 'Provide the trained classifiers and their prediction outputs for the test set.' },
                { phase: 'VI. Fusion Stage', role: ['integration'], text: '<strong>Implement and test all late fusion strategies (averaging, weighted, stacking).</strong> Train the meta-learner for the stacking approach.' },
                { phase: 'VII. Explainability (XAI)', role: ['imaging'], text: '<strong>Implement and generate Grad-CAM visualizations</strong> for the 3D DenseNet model. Analyze visual results for clinical relevance.' },
                { phase: 'VII. Explainability (XAI)', role: ['genomics'], text: '<strong>Implement and generate SHAP/LIME summary plots</strong> for the MLP model. Analyze feature importance for biological relevance.' },
                { phase: 'VIII. Evaluation', role: ['imaging'], text: 'Provide results for Stage 1 (Dice, etc.) and Stage 2A (AUC, F1, etc.).' },
                { phase: 'VIII. Evaluation', role: ['genomics'], text: 'Provide results for Stage 2B (AUC, F1, etc.).' },
                { phase: 'VIII. Evaluation', role: ['integration'], text: '<strong>Lead the design and execution of all evaluations and ablation studies.</strong> Generate final performance tables and plots. Synthesize all results.' },
                { phase: 'IX. Dissemination', role: ['imaging', 'genomics'], text: 'Contribute to the Methods and Results sections of the paper related to your pipeline.' },
                { phase: 'IX. Dissemination', role: ['integration'], text: '<strong>Lead the writing of the final research paper.</strong> Responsible for overall project documentation, code cleaning, and submission.' },
            ];

            const playbookData = [
                { title: 'Phase I: Project Foundations & Setup', content: 'This phase focuses on establishing a common ground. All team members must install the required software, set up the standardized `conda` environment, and achieve a functional understanding of the project\'s core scientific and technical principles. The Integration Lead will set up the GitHub repository and define the branching strategy.' },
                { title: 'Phase II: Multi-Modal Data Acquisition & Harmonization', content: 'Led by the Integration Lead, this data engineering phase acquires all necessary data from KiTS23, TCIA, and the GDC portal. The most critical task is creating a single, unified "master key" CSV file that correctly links every patient\'s imaging data, genomic data, and ground-truth clinical labels using their TCGA patient ID.' },
                { title: 'Phase III & IV: Stage 1 & 2A - Imaging Pipeline', content: 'The Imaging Specialist takes the lead. First, train and validate the 3D U-Net for segmentation exclusively on the KiTS23 dataset. Then, apply this trained model to the TCGA CT scans to generate predicted segmentation masks. These masks are used to automatically crop tumor ROIs, which then become the input for training the 3D DenseNet classification model.' },
                { title: 'Phase V: Stage 2B - Genomics Pipeline', content: 'In parallel, the Genomics Specialist builds the genomics classifier. This involves extensive preprocessing of the RNA-Seq data, including aggressive feature selection (e.g., using `SelectKBest`) to reduce dimensionality and prevent overfitting. A simple Multi-Layer Perceptron (MLP) is then trained on the selected gene features.' },
                { title: 'Phase VI: The Fusion Stage', content: 'The Integration Lead combines the outputs of the two specialist pipelines. Predictions from the CT-based model and the genomics-based model are gathered. Late fusion techniques, from simple averaging to a more complex stacking approach with a meta-learner (e.g., Logistic Regression), will be implemented and tested to produce a final, unified prediction.' },
                { title: 'Phase VII: Explainability (XAI)', content: 'To ensure our models are not "black boxes," each specialist will implement explainability techniques. The Imaging Specialist will use Grad-CAM to generate heatmaps showing which parts of the tumor the CT model focused on. The Genomics Specialist will use SHAP to identify which genes were most influential in the genomics model\'s predictions.' },
                { title: 'Phase VIII & IX: Evaluation & Dissemination', content: 'Led by the Integration Lead, this final phase involves rigorously measuring model performance using appropriate metrics (Dice, AUC, F1-score) and conducting ablation studies to prove the value of each component. The team will then synthesize all findings into a high-impact research paper for publication.' },
            ];

            const libraries = [
                { name: 'PyTorch', role: 'Core deep learning framework for all models.' },
                { name: 'MONAI', role: 'Specialized PyTorch-based framework for medical imaging.' },
                { name: 'Pandas', role: 'Primary tool for all tabular data operations (TCGA data).' },
                { name: 'Scikit-learn', role: 'For classical ML tasks: data splitting, feature selection, and the fusion meta-learner.' },
                { name: 'SimpleITK / Nibabel', role: 'Essential for medical image I/O, especially converting DICOM to NIfTI.' },
                { name: 'Matplotlib / Seaborn', role: 'For data visualization and plotting results.' },
                { name: 'Medcam', role: 'For generating 3D Grad-CAM visualizations for the imaging model.' },
                { name: 'SHAP / LIME', role: 'For generating feature importance explanations for the genomics model.' },
            ];

            const datasets = [
                { name: 'KiTS23', portal: 'GitHub', purpose: 'Primary source for CT scans with high-quality manual segmentation masks. Used to train the 3D U-Net.', url: 'https://github.com/neheller/kits23' },
                { name: 'TCGA-KIRC/KIRP (TCIA)', portal: 'The Cancer Imaging Archive', purpose: 'Source for radiological images (CT scans) corresponding to TCGA patients.', url: 'https://www.cancerimagingarchive.net/' },
                { name: 'TCGA-KIRC/KIRP (GDC)', portal: 'Genomic Data Commons', purpose: 'Source for matching RNA-Seq and clinical data, including the ground-truth subtype labels.', url: 'https://portal.gdc.cancer.gov/' },
            ];

            const knowledgeBase = [
                { title: 'Clinical Context: RCC Subtypes', content: 'Renal Cell Carcinoma (RCC) is not a single disease. We focus on three main subtypes: Clear Cell (ccRCC, most common and aggressive), Papillary (pRCC), and Chromophobe (chRCC, best prognosis). Accurate pre-surgical differentiation is crucial as it dictates treatment strategy, from active surveillance to aggressive intervention.' },
                { title: 'Architecture: 3D U-Net', content: 'The U-Net is the state-of-the-art for medical image segmentation. Its "U" shape consists of an encoder (capturing what is in the image) and a decoder (localizing where it is). The key innovation is "skip connections," which feed high-resolution spatial details from the encoder directly to the decoder, enabling highly precise segmentation boundaries.' },
                { title: 'Architecture: CNN (DenseNet)', content: 'For the classification task on cropped tumors, we use a Convolutional Neural Network (CNN). Specifically, a 3D DenseNet. Its architecture is excellent at feature extraction from images. Its "dense" connections, where each layer connects to all subsequent layers, improve feature flow and performance.' },
                { title: 'Data Modality: RNA-Seq', content: 'RNA-Sequencing provides a snapshot of gene activity. The data is a large table where rows are patients and columns are genes (~20,000+). This high dimensionality ("p >> n" problem) makes models prone to overfitting, which is why aggressive feature selection is a mandatory preprocessing step for the genomics pipeline.' },
                { title: 'Methodology: Late Fusion', content: 'We use late fusion to combine our two models. This means we train the CT model and the Genomics model independently. We then combine their prediction *outputs* (probabilities) to make a final decision. This is more modular and robust to missing data than early fusion, where raw data is combined at the input level.' },
            ];

            // --- Gemini API Integration ---
            const conceptSelect = document.getElementById('concept-select');
            const playbookSelect = document.getElementById('playbook-select');

            knowledgeBase.forEach(item => {
                const option = document.createElement('option');
                option.value = item.title;
                option.textContent = item.title;
                conceptSelect.appendChild(option);
            });

            playbookData.forEach(item => {
                const option = document.createElement('option');
                option.value = item.title;
                option.textContent = item.title;
                playbookSelect.appendChild(option);
            });

            async function callGemini(prompt, button, outputElement) {
                const loader = button.querySelector('.loader');
                const btnText = button.querySelector('.btn-text');

                button.disabled = true;
                loader.classList.remove('hidden');
                btnText.classList.add('hidden');
                outputElement.classList.add('hidden');
                outputElement.textContent = '';

                try {
                    // Use the secure backend proxy instead of direct API call
                    const response = await fetch('/api/gemini', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt: prompt })
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                        throw new Error(`Server Error: ${response.status} - ${errorData.error || response.statusText}`);
                    }

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        outputElement.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\* (.*?)(?=\n\* |$)/g, '<li>$1</li>').replace(/<li>/g, '<li class="list-disc ml-5">');
                        outputElement.classList.remove('hidden');
                    } else {
                        outputElement.textContent = 'Error: Received an empty or invalid response from the API.';
                        outputElement.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error("Gemini API call failed:", error);
                    outputElement.textContent = `An error occurred: ${error.message}`;
                    outputElement.classList.remove('hidden');
                } finally {
                    button.disabled = false;
                    loader.classList.add('hidden');
                    btnText.classList.remove('hidden');
                }
            }
            
            document.getElementById('decompose-task-btn').addEventListener('click', () => {
                const taskInput = document.getElementById('task-input').value;
                if (!taskInput) {
                    alert('Please enter a task.');
                    return;
                }
                const prompt = `You are an expert ML engineering manager specializing in medical AI projects. Break down the following high-level task into a detailed, actionable checklist of sub-tasks for a junior ML engineer. Format the output as a list. Task: "${taskInput}"`;
                callGemini(prompt, document.getElementById('decompose-task-btn'), document.getElementById('task-output'));
            });

            document.getElementById('explain-concept-btn').addEventListener('click', () => {
                const selectedConcept = knowledgeBase.find(c => c.title === conceptSelect.value);
                if (!selectedConcept) return;
                const prompt = `You are a patient and clear science communicator. Explain the following concept to a team member who is intelligent but not an expert in this specific domain. Use analogies if helpful, but keep it concise and focused on the core idea. Concept: "${selectedConcept.title}". Original description for context: "${selectedConcept.content}"`;
                callGemini(prompt, document.getElementById('explain-concept-btn'), document.getElementById('concept-output'));
            });
            
            document.getElementById('identify-risk-btn').addEventListener('click', () => {
                const selectedPhase = playbookData.find(p => p.title === playbookSelect.value);
                if (!selectedPhase) return;
                const prompt = `You are a senior project manager with deep experience in complex, multi-modal AI research projects. For the following project phase, identify 3-4 potential technical or logistical risks. For each risk, suggest a concrete mitigation strategy. Format as a list of risks, each with its own mitigation. Phase: "${selectedPhase.title}". Description: "${selectedPhase.content}"`;
                callGemini(prompt, document.getElementById('identify-risk-btn'), document.getElementById('risk-output'));
            });
            // --- End Gemini API Integration ---


            function renderTasks(filter = 'all') {
                taskListContainer.innerHTML = '';
                const groupedTasks = tasks.reduce((acc, task) => {
                    (acc[task.phase] = acc[task.phase] || []).push(task);
                    return acc;
                }, {});

                for (const phase in groupedTasks) {
                    const phaseTasks = groupedTasks[phase].filter(task => filter === 'all' || task.role.includes(filter));
                    if (phaseTasks.length > 0) {
                        const phaseHeader = document.createElement('h3');
                        phaseHeader.className = 'text-lg font-semibold text-slate-700 mt-6 mb-2 border-b pb-2';
                        phaseHeader.textContent = phase;
                        taskListContainer.appendChild(phaseHeader);

                        phaseTasks.forEach(task => {
                            const card = document.createElement('div');
                            card.className = 'task-card bg-white p-4 rounded-lg shadow-sm flex items-start gap-4';
                            card.setAttribute('data-roles', task.role.join(' '));
                            
                            let rolesHTML = '';
                            if (task.role.includes('imaging')) rolesHTML += '<span class="flex-shrink-0 text-xs font-bold bg-blue-100 text-blue-700 py-1 px-2 rounded-full">Imaging</span>';
                            if (task.role.includes('genomics')) rolesHTML += '<span class="flex-shrink-0 text-xs font-bold bg-green-100 text-green-700 py-1 px-2 rounded-full">Genomics</span>';
                            if (task.role.includes('integration')) rolesHTML += '<span class="flex-shrink-0 text-xs font-bold bg-amber-100 text-amber-700 py-1 px-2 rounded-full">Integration</span>';

                            card.innerHTML = `
                                <div class="w-1/3 flex flex-wrap gap-1">${rolesHTML}</div>
                                <div class="w-2/3 text-slate-600">${task.text}</div>
                            `;
                            taskListContainer.appendChild(card);
                        });
                    }
                }
            }
            
            function renderPlaybook() {
                playbookData.forEach((item, index) => {
                    const accordionItem = document.createElement('div');
                    accordionItem.className = 'bg-white rounded-lg shadow-sm';
                    accordionItem.innerHTML = `
                        <button class="accordion-header w-full flex justify-between items-center text-left p-4 font-semibold text-slate-800 hover:bg-slate-50">
                            <span>${item.title}</span>
                            <span class="transform transition-transform duration-300 text-blue-500">&#9662;</span>
                        </button>
                        <div class="accordion-content">
                            <div class="p-4 border-t border-slate-200 text-slate-600">
                                <p>${item.content}</p>
                            </div>
                        </div>
                    `;
                    accordionContainer.appendChild(accordionItem);
                });
            }

            function renderToolkit() {
                const libCard = document.createElement('div');
                libCard.className = 'bg-white p-6 rounded-lg shadow-md';
                libCard.innerHTML = `<h3 class="text-xl font-bold text-slate-800 mb-4">Core Libraries</h3><div class="space-y-4"></div>`;
                const libList = libCard.querySelector('.space-y-4');
                libraries.forEach(lib => {
                    const item = document.createElement('div');
                    item.innerHTML = `<p class="font-semibold text-slate-700">${lib.name}</p><p class="text-sm text-slate-500">${lib.role}</p>`;
                    libList.appendChild(item);
                });
                librariesContainer.appendChild(libCard);
                
                const dataCard = document.createElement('div');
                dataCard.className = 'bg-white p-6 rounded-lg shadow-md';
                dataCard.innerHTML = `<h3 class="text-xl font-bold text-slate-800 mb-4">Datasets</h3><div class="space-y-4"></div>`;
                const dataList = dataCard.querySelector('.space-y-4');
                datasets.forEach(data => {
                    const item = document.createElement('div');
                    item.innerHTML = `
                        <p class="font-semibold text-slate-700">${data.name} <span class="text-sm font-normal text-slate-500">- ${data.portal}</span></p>
                        <p class="text-sm text-slate-500 mb-1">${data.purpose}</p>
                        <a href="${data.url}" target="_blank" class="text-sm text-blue-600 hover:underline">Access Link &rarr;</a>
                    `;
                    dataList.appendChild(item);
                });
                datasetsContainer.appendChild(dataCard);
            }

            function renderKnowledgeBase() {
                knowledgeBase.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'bg-white p-6 rounded-lg shadow-md';
                    card.innerHTML = `
                        <h3 class="text-xl font-bold text-slate-800 mb-3">${item.title}</h3>
                        <p class="text-slate-600 leading-relaxed">${item.content}</p>
                    `;
                    knowledgeBaseContainer.appendChild(card);
                });
            }

            function handleNav(hash) {
                sections.forEach(section => {
                    if ('#' + section.id === hash) {
                        section.classList.remove('hidden');
                    } else {
                        section.classList.add('hidden');
                    }
                });
                navLinks.forEach(link => {
                    if (link.getAttribute('href') === hash) {
                        link.classList.add('active');
                    } else {
                        link.classList.remove('active');
                    }
                });
            }

            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetHash = e.currentTarget.getAttribute('href');
                    window.location.hash = targetHash;
                });
            });

            window.addEventListener('hashchange', () => handleNav(window.location.hash));
            
            handleNav(window.location.hash || '#dashboard');

            roleFilterButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    const role = e.currentTarget.dataset.role;
                    renderTasks(role);
                    roleFilterButtons.forEach(btn => btn.classList.remove('active', 'bg-blue-600', 'text-white'));
                    e.currentTarget.classList.add('active', 'bg-blue-600', 'text-white');
                });
            });
            
            accordionContainer.addEventListener('click', function(e) {
                const header = e.target.closest('.accordion-header');
                if (!header) return;
                const content = header.nextElementSibling;
                const arrow = header.querySelector('span:last-child');
                
                content.classList.toggle('open');
                arrow.classList.toggle('rotate-180');
            });

            const ctx = document.getElementById('performanceChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['CT-Only Classifier', 'Genomics-Only Classifier', 'Fused Model'],
                    datasets: [{
                        label: 'Target ROC-AUC Score',
                        data: [0.88, 0.85, 0.92],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.6)', // blue-500
                            'rgba(16, 185, 129, 0.6)', // green-500
                            'rgba(245, 158, 11, 0.6)'  // amber-500
                        ],
                        borderColor: [
                            'rgba(37, 99, 235, 1)',
                            'rgba(5, 150, 105, 1)',
                            'rgba(217, 119, 6, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 0.75,
                            max: 1.0,
                            title: {
                                display: true,
                                text: 'Area Under Curve (AUC)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(2);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });

            renderTasks();
            renderPlaybook();
            renderToolkit();
            renderKnowledgeBase();

            // --- Team Chat & Notes --- //
            const loginPrompt = document.getElementById('login-prompt');
            const chatInterface = document.getElementById('chat-interface');
            const noteCreator = document.getElementById('note-creator');
            const addNoteBtn = document.getElementById('add-note-btn');
            const clearNotesBtn = document.getElementById('clear-notes-btn');
            const clearChatBtn = document.getElementById('clear-chat-btn');

            // Remove login prompt and always show chat/notes
            loginPrompt.classList.add('hidden');
            chatInterface.classList.remove('hidden');
            addNoteBtn.classList.remove('hidden');
            clearNotesBtn.classList.remove('hidden');
            clearChatBtn.classList.remove('hidden');

            let socket = null;
            let currentChannel = 'general';
            function setupSocket() {
                if (socket) socket.disconnect();
                if (!currentUserId) return; // Only connect if logged in
                socket = io({ query: { userId: currentUserId } });
                socket.on('connect', () => {
                    socket.emit('join_channel', currentChannel);
                });
                socket.on('message_history', (messages) => {
                    renderMessages(messages);
                });
                socket.on('receive_message', (msg) => {
                    appendMessage(msg);
                });
            }

            // Persistent login using localStorage
            function saveLogin(user) {
                localStorage.setItem('loggedInUser', JSON.stringify(user));
            }
            function clearLogin() {
                localStorage.removeItem('loggedInUser');
            }
            function getSavedLogin() {
                try {
                    return JSON.parse(localStorage.getItem('loggedInUser'));
                } catch (e) { return null; }
            }

            // On page load, check for saved login
            const savedUser = getSavedLogin();
            if (savedUser && savedUser._id) {
                currentUserId = savedUser._id;
                currentUser = savedUser;
                userSelect.value = currentUserId;
                showApp();
                setupSocket();
            } else {
                hideApp();
            }

            // Only call setupSocket after login
            function onLoginSuccess() {
                showApp();
                setupSocket();
            }

            document.getElementById('login-submit-btn').addEventListener('click', async () => {
                const name = document.getElementById('login-user-select').value;
                const password = document.getElementById('login-password').value;
                const errorMsg = document.getElementById('login-error-msg');
                errorMsg.classList.add('hidden');
                try {
                    const res = await fetch('/api/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, password })
                    });
                    const data = await res.json();
                    console.log('Login response:', data);
                    if (!res.ok) {
                        errorMsg.textContent = data.error || 'Invalid credentials';
                        errorMsg.classList.remove('hidden');
                        return;
                    }
                    const user = data;
                    currentUserId = user._id;
                    currentUser = user;
                    userSelect.value = currentUserId;
                    saveLogin(user);
                    onLoginSuccess();
                } catch (e) {
                    errorMsg.textContent = 'Login failed';
                    errorMsg.classList.remove('hidden');
                }
            });

            // Set user on selector change (profile switch)
            userSelect.addEventListener('change', () => {
                currentUserId = userSelect.value;
                currentUser = users.find(u => u._id === currentUserId);
                saveLogin(currentUser);
                setupSocket(); // reconnect socket with new userId
            });
            // Logout
            document.getElementById('logout-btn').addEventListener('click', () => {
                currentUserId = null;
                currentUser = null;
                if (socket) socket.disconnect();
                clearLogin();
                hideApp();
                document.getElementById('login-password').value = '';
            });

            // Channel switching
            document.querySelectorAll('.channel-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.channel-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentChannel = this.dataset.channel;
                    document.getElementById('current-channel').textContent = this.textContent + ' Chat';
                    if (socket) socket.emit('join_channel', currentChannel);
                });
            });
            // Send message
            document.getElementById('send-btn').addEventListener('click', () => {
                const messageInput = document.getElementById('message-input');
                const message = messageInput.value.trim();
                if (message && socket) {
                    socket.emit('new_message', { content: message, channel: currentChannel });
                    messageInput.value = '';
                }
            });
            function renderMessages(messages) {
                const messagesContainer = document.getElementById('messages-container');
                messagesContainer.innerHTML = '';
                messages.forEach(msg => appendMessage(msg));
            }
            function appendMessage(msg) {
                const messagesContainer = document.getElementById('messages-container');
                const messageElement = document.createElement('div');
                messageElement.innerHTML = `
                    <div>
                        <span class="font-bold">${msg.sender?.name || 'Unknown'}</span>
                        <span class="text-xs text-gray-500">${new Date(msg.createdAt).toLocaleTimeString()}</span>
                    </div>
                    <p class="text-gray-700">${msg.content}</p>
                `;
                messagesContainer.appendChild(messageElement);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            // --- Notes ---
            async function loadNotes() {
                try {
                    const response = await fetch('/api/notes');
                    const notes = await response.json();
                    const notesContainer = document.getElementById('notes-container');
                    notesContainer.innerHTML = '';
                    notes.forEach(note => {
                        const noteElement = document.createElement('div');
                        noteElement.className = 'bg-white p-4 rounded-lg shadow-sm flex justify-between items-start';
                        noteElement.innerHTML = `
                            <div>
                                <h4 class="font-bold text-lg">${note.title}</h4>
                                <p class="text-sm text-gray-500">By ${note.author?.name || 'Unknown'} on ${new Date(note.createdAt).toLocaleDateString()}</p>
                                <p class="mt-2">${note.content}</p>
                            </div>
                            <button class="delete-note-btn text-red-600 hover:underline ml-4" data-id="${note.id}">Delete</button>
                        `;
                        notesContainer.appendChild(noteElement);
                    });
                    // Attach delete event listeners
                    document.querySelectorAll('.delete-note-btn').forEach(btn => {
                        btn.addEventListener('click', async function() {
                            const noteId = this.getAttribute('data-id');
                            await fetch(`/api/notes/${noteId}`, { method: 'DELETE' });
                            loadNotes();
                        });
                    });
                } catch (error) {
                    console.error('Failed to load notes:', error);
                }
            }
            addNoteBtn.addEventListener('click', () => {
                noteCreator.classList.remove('hidden');
            });
            document.getElementById('cancel-note-btn').addEventListener('click', () => {
                noteCreator.classList.add('hidden');
            });
            document.getElementById('save-note-btn').addEventListener('click', async () => {
                const title = document.getElementById('note-title').value;
                const content = document.getElementById('note-content').value;
                const phase = document.getElementById('note-phase').value;
                const tags = document.getElementById('note-tags').value.split(',').map(tag => tag.trim());
                try {
                    const response = await fetch('/api/notes', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ authorId: currentUserId, title, content, phase, tags })
                    });
                    if (response.ok) {
                        loadNotes();
                        noteCreator.classList.add('hidden');
                        document.getElementById('note-title').value = '';
                        document.getElementById('note-content').value = '';
                        document.getElementById('note-phase').value = 'general';
                        document.getElementById('note-tags').value = '';
                    } else {
                        const errorData = await response.json();
                        alert(`Failed to save note: ${errorData.error}`);
                    }
                } catch (error) {
                    console.error('Error saving note:', error);
                }
            });
            loadNotes();

            // Clear all notes
            document.getElementById('clear-notes-btn').addEventListener('click', async () => {
                if (confirm('Are you sure you want to delete all notes?')) {
                    await fetch('/api/clear-notes', { method: 'POST' });
                    loadNotes();
                }
            });
            // Clear chat
            document.getElementById('clear-chat-btn').addEventListener('click', async () => {
                if (confirm('Are you sure you want to clear the chat?')) {
                    await fetch('/api/clear-chat', { method: 'POST' });
                    // Clear chat window
                    document.getElementById('messages-container').innerHTML = '';
                }
            });
        });
    </script>
</body>
</html>

